<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Regularization Mode &mdash; saenopy 1.0.6 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="_static/sg_gallery-rendered-html.css" type="text/css" />
      <link rel="stylesheet" href="_static/nbsphinx-code-cells.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Mesh" href="mesh.html" />
    <link rel="prev" title="Boundary Condition Mode" href="boundarycondition.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            saenopy
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="interface.html">Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="boundarycondition.html">Boundary Condition Mode</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Regularization Mode</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Theory">Theory</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Example">Example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="mesh.html">Mesh</a></li>
<li class="toctree-l1"><a class="reference internal" href="material.html">Material</a></li>
<li class="toctree-l1"><a class="reference internal" href="auto_examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="ReadInData.html">Read Files with Pyhton</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">saenopy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Regularization Mode</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/regularization.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Regularization-Mode">
<span id="sectionregularizationmode"></span><h1>Regularization Mode<a class="headerlink" href="#Regularization-Mode" title="Permalink to this heading">¶</a></h1>
<p>This example will explain the basic usage of a regularisation with saenopy.</p>
<p>Regularization mode solves the unconstrained problem of measured displacements, which should be fitted by deforming the mesh and thereby generating forces. To avoid spurious forces all over the mesh, a regularization term is used to suppress “noise” forces.</p>
<dl class="simple">
<dt>The input is:</dt><dd><ul class="simple">
<li><p>the material parameters (see <a class="reference internal" href="material.html#sectionmaterial"><span class="std std-ref">Material</span></a>)</p></li>
<li><p>the mesh (nodes and connectivity) (see <a class="reference internal" href="mesh.html#sectionmesh"><span class="std std-ref">Mesh</span></a>)</p></li>
<li><p>the measured displacements <span class="math notranslate nohighlight">\(U^\mathrm{measured}_i\)</span> for all nodes</p></li>
</ul>
</dd>
<dt>The output is:</dt><dd><ul class="simple">
<li><p>the forces <span class="math notranslate nohighlight">\(f_i(U)\)</span> for all nodes</p></li>
<li><p>the displacements <span class="math notranslate nohighlight">\(U_i\)</span> for all nodes (should be similar to the measured displacements)</p></li>
</ul>
</dd>
</dl>
<p>This mode is used to calculate from a measured noisy displacement field, the forces that generated this displacement field.</p>
<p>First the basic theoretical background is explained, followed by the code to use it.</p>
<section id="Theory">
<h2>Theory<a class="headerlink" href="#Theory" title="Permalink to this heading">¶</a></h2>
<p>The inverse problem, to fit forces for measured displacements is under determined. Therefore, a regularization scheme is needed, to circumvent this problem. The target function <span class="math notranslate nohighlight">\(L(U)\)</span> is extended with a regularisation term. We use here the Thikonov regularization, <span class="math notranslate nohighlight">\(|f_i(U)|^2_A\)</span>, the weighted sum over all forces (other regularization schemes can also be used).</p>
<div class="math notranslate nohighlight">
\[L(U) = | U_i - U_i^\mathrm{measured}|^2 + |f_i(U)|^2_A\]</div>
<p>The subscript <span class="math notranslate nohighlight">\(A\)</span> denotes here a weighted sum over the forces. If <span class="math notranslate nohighlight">\(A\)</span> would be a constant, forces at every point of the volume would be penalized the same. But we normally expect strong forces at a few nodes, caused by the cell, and small forces at other nodes, caused by noise.</p>
<p>To not smooth the strongest forces, a lower weight is assigned to nodes which obtained a high force in the iteration process (Huber, 2004).</p>
<div class="math notranslate nohighlight">
\[\begin{split}A_{ii}(f_i) = \begin{cases}
  \alpha, &amp; \text{if}\ |f_i| &lt; 1.345 \cdot \mathrm{median}(|f|) \\
  \alpha \frac{1.345 \cdot \mathrm{median}(|f|)}{|f_i|}, &amp; \text{otherwise}
\end{cases}\end{split}\]</div>
<p>The target function <span class="math notranslate nohighlight">\(L(U)\)</span> is minimized if <span class="math notranslate nohighlight">\(U\)</span> fulfills the following condition:</p>
<div class="math notranslate nohighlight">
\[\underbrace{(\mathbf{I} + \mathbf{K}(U) \cdot \mathbf{A} \cdot \mathbf{K}(U))_{ij}}_{A_{ij}} \cdot \underbrace{\Delta u_j}_{x_j} = \underbrace{U_i^\mathrm{measured} + (\mathbf{K}(U) \cdot \mathbf{A} \cdot f(U))_i}_{b_i}\]</div>
<p>This linear equation (of the form <span class="math notranslate nohighlight">\(A_{ij}\cdot x_j = b_i\)</span>) is solved using the conjugate gradient method to obtain a value for <span class="math notranslate nohighlight">\(\Delta u_i\)</span>. A tiny fraction (<cite>stepper</cite>) of this is applied to the displacement <span class="math notranslate nohighlight">\(U_i\)</span>:</p>
<div class="math notranslate nohighlight">
\[U^\prime_i = U_i + \mathrm{stepper} \cdot \Delta u_i.\]</div>
<p>With the new displacement <span class="math notranslate nohighlight">\(U^\prime\)</span>, the stiffness matrix <span class="math notranslate nohighlight">\(K_{ij}(U^\prime)\)</span>, the nodal forces <span class="math notranslate nohighlight">\(f_i(U^\prime)\)</span> and the total energy <span class="math notranslate nohighlight">\(E(U^\prime)\)</span> are updated.</p>
<p>From these nodal forces the weight matrix <span class="math notranslate nohighlight">\(A_{ii}(f_i(U^\prime))\)</span> is updated. And the linear equation is again solved for the new stiffness matrix <span class="math notranslate nohighlight">\(K_{ij}(U^\prime)\)</span> and weight matrix <span class="math notranslate nohighlight">\(A_{ii}(f_i(U^\prime))\)</span>.</p>
<p>This procedure is iterated until the total energy <span class="math notranslate nohighlight">\(E\)</span> of the system converges. The convergence criterion is:</p>
<div class="math notranslate nohighlight">
\[\frac{\mathrm{std}(\{E^{t-6}, E^{t-5}, ..., E^{t-1}, E^t\})}{\mathrm{mean}(\{E^{t-6}, E^{t-5}, ..., E^{t-1}, E^t\})} \leq \mathrm{rel\_conv\_crit}\]</div>
<p>So when the standard deviation of <span class="math notranslate nohighlight">\(E\)</span> divided by the mean of <span class="math notranslate nohighlight">\(E\)</span> for the last 6 iterations is lower than the threshold <cite>rel_conv_crit</cite>.</p>
</section>
<section id="Example">
<h2>Example<a class="headerlink" href="#Example" title="Permalink to this heading">¶</a></h2>
<p>The following code example (the code of all boxed joined in a single file) can be downloaded at <a class="reference external" href="https://raw.githubusercontent.com/rgerum/saenopy/master/docs/regularization.py">regularization.py</a>.</p>
<p>First, import the Solver class.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">saenopy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Solver</span>

<span class="c1"># initialize the object</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Set the material model (see <a class="reference internal" href="material.html#sectionmaterial"><span class="std std-ref">Material</span></a>):</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">saenopy.materials</span><span class="w"> </span><span class="kn">import</span> <span class="n">SemiAffineFiberMaterial</span>

<span class="c1"># provide a material model</span>
<span class="n">material</span> <span class="o">=</span> <span class="n">SemiAffineFiberMaterial</span><span class="p">(</span><span class="mi">1645</span><span class="p">,</span> <span class="mf">0.0008</span><span class="p">,</span> <span class="mf">1.0075</span><span class="p">,</span> <span class="mf">0.033</span><span class="p">)</span>
<span class="n">M</span><span class="o">.</span><span class="n">setMaterialModel</span><span class="p">(</span><span class="n">material</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Define the mesh (see <a class="reference internal" href="mesh.html#sectionmesh"><span class="std std-ref">Mesh</span></a>).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># define the coordinates of the nodes of the mesh</span>
<span class="c1"># the array has to have the shape N_v x 3</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>  <span class="c1"># 0</span>
              <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>  <span class="c1"># 1</span>
              <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>  <span class="c1"># 2</span>
              <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>  <span class="c1"># 3</span>
              <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span>  <span class="c1"># 4</span>
              <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span>  <span class="c1"># 5</span>
              <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span>  <span class="c1"># 6</span>
              <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]])</span> <span class="c1"># 7</span>

<span class="c1"># define the tetrahedra of the mesh</span>
<span class="c1"># the array has to have the shape N_t x 4</span>
<span class="c1"># every entry is an index referencing a verces in R (indices start with 0)</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
              <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
              <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>
              <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>
              <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span>
</pre></div>
</div>
</div>
<p>And hand the data over to the Solver object.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># provide the node data</span>
<span class="n">M</span><span class="o">.</span><span class="n">setNodes</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
<span class="c1"># and the tetrahedron data</span>
<span class="n">M</span><span class="o">.</span><span class="n">setTetrahedra</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now we have to specify which displacements to fit (see <a class="reference internal" href="mesh.html#sectionmeasureddisplacement"><span class="std std-ref">Measured displacement</span></a>).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># the displacements of the nodes which shall be fitted</span>
<span class="c1"># during the solving</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span>   <span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># 0</span>
              <span class="p">[</span><span class="mi">0</span>   <span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># 1</span>
              <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># 2</span>
              <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># 3</span>
              <span class="p">[</span><span class="mi">0</span>   <span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># 4</span>
              <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># 5</span>
              <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># 6</span>
              <span class="p">[</span><span class="mi">0</span>   <span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span> <span class="c1"># 7</span>

<span class="c1"># hand the displacements over to the class instance</span>
<span class="n">M</span><span class="o">.</span><span class="n">setTargetDisplacements</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now we can start the regularisation process (see parameters see <a class="reference internal" href="api.html#saenopy.solver.Solver.solve_regularized" title="saenopy.solver.Solver.solve_regularized"><code class="xref py py-meth docutils literal notranslate"><span class="pre">solve_regularized()</span></code></a>).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># call the regularisation</span>
<span class="n">M</span><span class="o">.</span><span class="n">solve_regularized</span><span class="p">(</span><span class="n">stepper</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.001</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
e:\saenopy\saenopy\solver.py:339: NumbaWarning: <span class="ansi-bold">Cannot cache compiled function &#34;_get_applied_epsilon&#34; as it uses dynamic globals (such as ctypes pointers and large global arrays)</span>
  @staticmethod
</pre></div></div>
</div>
<p>We can now view the result with the integrated mesh viewer. The nodes (yellow points) are connected by tetrahedra (yellow lines). The displacements (green vectors) cause the reaction forces (red vectors).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">M</span><span class="o">.</span><span class="n">viewMesh</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<h1></h1><iframe srcdoc='
    <!--<div id="info"><a href="http://threejs.org" target="_blank" rel="noopener">three.js</a> - dashed lines example</div>-->
    <div id="container"></div>

    <script src="https://threejs.org/build/three.js"></script>

    <script src="https://threejs.org/examples/js/WebGL.js"></script>
    <script src="https://threejs.org/examples/js/libs/stats.min.js"></script>
    <script src="https://threejs.org/examples/js/libs/dat.gui.min.js"></script>

    <script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>

    <style>

    .dg li {
        background: #f7f7f7 !important;
    }
    .dg {
       color: #111;
       text-shadow: none;
    }
    .dg.main .close-button {
        background: none;
    }
    .dg.main .close-button:hover {
       background: none;
    }
    .dg .cr.boolean {
        border-left: 1px solid #cfcfcf;
    }
    .dg .cr.number {
        border-left: 1px solid #cfcfcf;
    }
    .dg .c input[type=text] {
        background: #fffefe00;
        outline: none;
        color: #111 !important;
    }
    .dg .c input[type=text]:hover {
        background: #fffefe00;
        outline: none;
        color: #111 !important;
    }
    .dg .c .slider {
        background: #d6d6d6;
        cursor: ew-resize;
        border-radius: 5px;
    }
    .dg .c .slider:hover {
        background: #d6d6d6;
    }
    .dg .c .slider-fg {
        background: #747575;
        border-radius: 5px;
    }
    .dg .c .slider:hover .slider-fg {
       background: #42a5f5;
    }
    .dg li:not(.folder) {
        border: 1px solid #cfcfcf;
        border-radius: 2px;
    }

    </style>

    <script>

    function NewArray(type, base64) {
        var binary_string =  window.atob(base64);
        var len = binary_string.length;
        var bytes = new Uint8Array( len );
        for (var i = 0; i < len; i++)        {
            bytes[i] = binary_string.charCodeAt(i);
        }
        return new type(bytes.buffer);
    }

        //if ( WEBGL.isWebGLAvailable() === false ) {
        //    document.body.appendChild( WEBGL.getWebGLErrorMessage() );
        //}

        var renderer, scene, camera, stats, controls;
        var objects = [];
        var gui;

        factor_mesh = 50.000000;
        factor_force = 1.000000;

        var WIDTH = window.innerWidth, HEIGHT = window.innerHeight;

        init();
        animate();

        function init() {

            camera = new THREE.PerspectiveCamera( 60, WIDTH / HEIGHT, 1, 200 );
            camera.position.z = 150;

            scene = new THREE.Scene();
            scene.background = new THREE.Color( 0xFFFFFF);//0x111111 );
            scene.fog = new THREE.Fog( 0xFFFFFF, 50, 200);

            renderer = new THREE.WebGLRenderer( { antialias: true } );
            renderer.setPixelRatio( window.devicePixelRatio );
            renderer.setSize( WIDTH, HEIGHT );

            var container = document.getElementById( "container" );
            container.appendChild( renderer.domElement );

            //stats = new Stats();
            //container.appendChild( stats.dom );

            //
            addMesh(NewArray(Float64Array, "AAAAAAAA4L8AAAAAAADgvwAAAAAAAOC/AAAAAAAA4L8AAAAAAADgPwAAAAAAAOC/AAAAAAAA4D8AAAAAAADgPwAAAAAAAOC/AAAAAAAA4D8AAAAAAADgvwAAAAAAAOC/AAAAAAAA4L8AAAAAAADgvwAAAAAAAOA/AAAAAAAA4D8AAAAAAADgvwAAAAAAAOA/AAAAAAAA4D8AAAAAAADgPwAAAAAAAOA/AAAAAAAA4L8AAAAAAADgPwAAAAAAAOA/"), NewArray(Int32Array, "BQAAAAcAAAABAAAAAgAAAAAAAAAEAAAABQAAAAYAAAACAAAABgAAAAYAAAAHAAAAAQAAAAcAAAAEAAAABwAAAAAAAAABAAAAAAAAAAMAAAACAAAABwAAAAAAAAAHAAAAAAAAAAUAAAADAAAABQAAAAIAAAADAAAAAAAAAAIAAAACAAAABQAAAAQAAAAFAAAA"), NewArray(Float64Array, "EAgYgIo0qT+YCt44OmCLv7Idx5Q1Goy/eFgg4mI5sz9OtMWRE9eJPxEm7jQPcIm/6QAwPIg3qb9WOLqn7GKLP4JrvKIPHYy/RpXd62I4s78TBehap9aJv/GArXBAaom/rqxxypE4sz8QIPtCf9OJv6RVsyXta4k/GVIhpQM0qb84LDJsjmGLv4yKOHynG4w/15SjvnE4s7/5OffettGJPxL317+fb4k/6ZQXXcE0qT9eNXwqOGCLPwZZW3tgGow/"), NewArray(Float64Array, "xNW4cztwcD9fzMA3DUsTPzAc8y29rhY/3JWWw2+qZz90VuhFAjlDv2U6neoBiEM/xWXxsAixcT8QQG8LG0sTv8/WSFNrtRY/lK0W06VLdj8rbXfR2TdDP7GIA8O3hUM/T9M5NLKqZz/LGoRdxTdDP72Hop6fhkO/niVkQsWwcT/B/XSVdkcTP0V7mg3QsBa/lmYkNahLdj+907qD4jZDv4mC8DjehkO/iCZQEjdwcD8heInsO0UTv8U9DyQ3tRa/"))
            window.addEventListener( "resize", onWindowResize, false );

            controls = new THREE.OrbitControls( camera, renderer.domElement );
            //controls.minDistance = 10;
            //controls.maxDistance = 500;
            initGui();

        }


        function addMesh(points1, lines1, F1, U1) {
            points = points1;
            lines = lines1;
            F = F1;
            U = U1;

            for(var i=0; i < points.length; i++) {
                points[i] *= factor_mesh;
                U[i] *= factor_mesh;
            }

            //var h = size * 0.5;

            var geometry = new THREE.BufferGeometry();
            var position = [];
            //console.log(points.length, tets.length);

            for(var t=0; t < lines1.length/2; t++) {
                        var t1 = lines1[t*2+0];
                        var t2 = lines1[t*2+1];
                        for(var x=0; x < 3; x++)
                            position.push(points[t1*3+x]);
                        for(var x=0; x < 3; x++)
                            position.push(points[t2*3+x]);
                //console.log(t);
            }
            console.log("ready");

            geometry.addAttribute( "position", new THREE.Float32BufferAttribute( position, 3 ) );

            //var geometryCube = cube( 50 );

            //var lineSegments = new THREE.LineSegments( geometry, new THREE.LineDashedMaterial( { color: 0xffaa00, dashSize: 3, gapSize: 1 } ) );
            mesh_lines = new THREE.LineSegments( geometry, new THREE.LineBasicMaterial( { color: 0xffaa00, linewidth: 0.5, transparent: true, opacity: 0.5} ) );
            mesh_lines.computeLineDistances();

            objects.push( mesh_lines );
            scene.add( mesh_lines );

            var geometry = new THREE.BufferGeometry();
            var position = [];
            var force_tips = [];

            for(var i=0; i < U.length/3; i++) {
                f_abs = Math.sqrt(F[i*3+0]**2 + F[i*3+1]**2 + F[i*3+2]**2);
                factor = factor_force*factor_mesh;//1/f_abs/3000 * f_abs * 100000;
                for(var x=0; x < 3; x++)
                    position.push((points[i*3+x]));
                for(var x=0; x < 3; x++) {
                    position.push(points[i * 3 + x] + F[i * 3 + x] * factor);
                    force_tips.push(points[i * 3 + x] + F[i * 3 + x] * factor);
                }
            }

            geometry.addAttribute( "position", new THREE.Float32BufferAttribute( position, 3 ) );

            force_mat = new THREE.LineBasicMaterial( { color: 0xaa0000, linewidth: 3,} );
            force_lines = new THREE.LineSegments( geometry, force_mat );
            force_lines.computeLineDistances();

            objects.push( force_lines );
            scene.add( force_lines );

            var sprite = new THREE.TextureLoader().load( "https://threejs.org/examples/textures/sprites/disc.png" );

            var geometry = new THREE.BufferGeometry();
            geometry.addAttribute( "position", new THREE.Float32BufferAttribute( points, 3 ) );
            mesh_points = new THREE.Points( geometry, new THREE.PointsMaterial( { size: 8, sizeAttenuation: false, color: 0xffaa00, map: sprite, alphaTest: 0.5, transparent: true } ) );
            scene.add( mesh_points );

            var geometry = new THREE.BufferGeometry();
            geometry.addAttribute( "position", new THREE.Float32BufferAttribute( force_tips, 3 ) );
            force_points = new THREE.Points( geometry, new THREE.PointsMaterial( { size: 10, sizeAttenuation: false, color: 0xaa0000, map: sprite, alphaTest: 0.5, transparent: true } ) );
            scene.add( force_points );

            // Displacements

            var geometry = new THREE.BufferGeometry();
            var position = [];
            var displacement_tips = [];

            for(var i=0; i < U.length/3; i++) {
                for(var x=0; x < 3; x++)
                    position.push((points[i*3+x]));
                for(var x=0; x < 3; x++) {
                    position.push(points[i * 3 + x] + U[i * 3 + x]);
                    displacement_tips.push(points[i * 3 + x] + U[i * 3 + x]);
                }
            }

            geometry.addAttribute( "position", new THREE.Float32BufferAttribute( position, 3 ) );
            displacement_mat = new THREE.LineBasicMaterial( { color: 0x00aa00, linewidth: 2,} );
            displacement_lines = new THREE.LineSegments( geometry, displacement_mat );
            displacement_lines.computeLineDistances();

            objects.push( displacement_lines );
            scene.add( displacement_lines );

            var geometry = new THREE.BufferGeometry();
            geometry.addAttribute( "position", new THREE.Float32BufferAttribute( displacement_tips, 3 ) );
            displacement_points = new THREE.Points( geometry, new THREE.PointsMaterial( { size: 10, sizeAttenuation: false, color: 0x00aa00, map: sprite, alphaTest: 0.5, transparent: true } ) );
            scene.add( displacement_points );
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize( window.innerWidth, window.innerHeight );
        }

        function animate() {
            requestAnimationFrame( animate );

            render();
            renderer.render( scene, camera );
            //stats.update();

        }

        function render() {

            var time = Date.now() * 0.001;

            scene.traverse( function ( object ) {

                //if ( object.isLine ) {

                    //object.rotation.y = 0.25 * time;
                    //object.rotation.y = 0.25 * time;

                //}

            } );

            renderer.render( scene, camera );

        }

        function initGui() {
            gui = new dat.GUI();
            var param = {
                "mesh": true,
                "forces": true,
                "force scale": 1,
                "displacements": true,
                "view_range" : 200,
            };
            gui.add( param, "mesh" ).onChange( function ( val ) {
                mesh_lines.visible = val;
                mesh_points.visible = val;
            } );
            gui.add( param, "forces" ).onChange( function ( val ) {
                force_lines.visible = val;
                force_points.visible = val;
            } );

            gui.add( param, "force scale", 1, 8, 0.1 ).onChange( function ( val ) {
                var position = [];
                var force_tips = [];

                for(var i=0; i < U.length/3; i++) {
                    f_abs = Math.sqrt(F[i * 3 + 0] ** 2 + F[i * 3 + 1] ** 2 + F[i * 3 + 2] ** 2);
                    factor = factor_force * factor_mesh * val;//1/f_abs/3000 * f_abs * 100000;
                    for (var x = 0; x < 3; x++)
                        position.push((points[i * 3 + x]));
                    for (var x = 0; x < 3; x++) {
                        position.push(points[i * 3 + x] + F[i * 3 + x] * factor);
                        force_tips.push(points[i * 3 + x] + F[i * 3 + x] * factor);
                    }
                }
                force_lines.geometry.addAttribute( "position", new THREE.Float32BufferAttribute( position, 3 ) );
                force_points.geometry.addAttribute( "position", new THREE.Float32BufferAttribute( force_tips, 3 ) );
            } );

            gui.add( param, "displacements" ).onChange( function ( val ) {
                displacement_lines.visible = val;
                displacement_points.visible = val;
            } );

            gui.add( param, "view_range", 10, 300, 1 ).onChange( function ( val ) {
                scene.fog.far = val;
            } );
        }

    </script>
    ' scrolling=no style='border:none; width: 100%; height: 600px'></iframe></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="boundarycondition.html" class="btn btn-neutral float-left" title="Boundary Condition Mode" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="mesh.html" class="btn btn-neutral float-right" title="Mesh" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2023, Richard Gerum, David Böhringer.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>